---
itle: "Datos INE"
editor: visual
editor_options: 
  chunk_output_type: console
---

## Preliminares

### Librerías

Manipulación de datos:

```{r}
#| messages: false
#| warning: false

library(dplyr)
library(tidyr)
library(rlang)
```

Manipulación de cadenas:

```{r}
library(stringr)
library(glue)
```

Programación funcional (`map` y similares):

```{r}
#| warning: false

library(purrr)
```

Lectura de hojas de cálculo:

```{r}
library(readr)
```

Tablas:

```{r}
library(tinytable)
library(modelsummary)
```

{{< include _global.qmd >}}

## Códigos de CC. AA., provincias y municipios

Códigos INE de los municipios.

```{r}
mun_codes <- read_csv(data_file("ine_mun_codes.csv"),
                      col_types = "cccc") |>
  mutate(mun_code = glue("{prov_code}{mun_order}"))
```

En el Atlas siguen apareciendo municipios que ya no existen, o que han cambiado de provincia.

| Código | Municipio    | Causa                                                  |
|---------------|---------------|-------------------------------------------|
| 04039  | Darrical     | Desaparece en 1997 incorporándose a Alcolea            |
| 12066  | Gatova       | Pasa a la provincia de Valencia en 1995                |
| 15026  | Cesuras      | Fusión en 2013 con Oza dos Ríos creándose Oza-Cesuras  |
| 15063  | Oza dos Ríos | Fusión en 2013 con Cesuras creándose Oza-Cesuras       |
| 17122  | Palmerola    | Desaparece en 1991 incorporándose a Les Lloses         |
| 36011  | Cerdedo      | Fusión en 2016 con Cotobade creándose Cerdedo-Cotobade |
| 36012  | Cotobade     | Fusión en 2016 con Cerdedo creándose Cerdedo-Cotobade  |

```{r}
drop_mun_codes <- c("04039", "12066", "15026", "15063", 
                    "17122", "36011", "36012")
```

## Atlas de la distribución de la renta

```{r}
# Nombres de las variables del Atlas
var_names <- read_csv(data_file("ine_atlas_vars.csv"),
                      col_types = "cc")

raw_data_dir <- "data/orig"

convert_numbers <- function(x) {
  x |>
    str_remove(fixed(".")) |>
    str_replace(fixed(","), ".") |>
    as.numeric()
}

# Se leen los valores de las variables como texto para
# evitar problemas con los valores ausentes que se codifican
# como la cadena "".
read_atlas_file <- function(csv_file) {
  read_delim(csv_file, delim = ";", col_types = "ccccic",
             na = c("", ".", "..")) |>
    filter(is.na(Distritos), is.na(Secciones)) |>
    filter(!is.na(Total)) |>
    mutate(mun_code = str_sub(Municipios, end = 5),
           value = convert_numbers(Total)) |>
    select(-c(Municipios, Distritos, Secciones, Total)) |>
    filter(!mun_code %in% drop_mun_codes) |>
    rename(var_label = 1, year = Periodo)
}
```

```{r}
# Datos del Atlas de distribución de renta de los hogares
# Serie 2015-2023
# Se usan 3 archivos CSV proporcionados por el INE:
# - 30824: Renta
# - 30832: Demografía
# - 37677: Distribución de la renta

base_names <- c("30824", "30832", "37677")
csv_files <- raw_data_file(glue("{base_names}.csv.xz"))

db <- map(csv_files, read_atlas_file) |>
  bind_rows() |>
  left_join(var_names, by = "var_label") |>
  select(-var_label) |>
  pivot_wider(names_from = var, values_from = value)

saveRDS(db, file = data_file("ine_atlas_data.rds"), compress = "xz")

```

```{r}
#| echo: false

datasummary_skim(db, 
                 fun_numeric = 
                   list(Mean = Mean, SD = SD, 
                        Min = Min, Median = Median, Max = Max, 
                        `Missing Pct.` = PercentMissing),
                 type = "numeric") |> 
  tt_style(j = 2:7, align = "r")
```

## Censo anual de población

```{r}
ine_educ_labels <- read_csv(data_file("ine_educ_labels.csv"), col_types = "ccc")

make_factor <- function(x) {
  labs <- ine_educ_labels |>
    filter(var == as_label(enquo(x)))
  new_levels  <- labs$level
  tbl <- new_levels
  names(tbl) <- labs$ine_label
  factor(tbl[x], levels = new_levels) |>
    unname()
}

# Lee los datos de población municipal por estudios completados,
# tramo de edad y sexo.
# Obtenidos del Censo anual de población publicado en el INE.
# Datos para todos los municipios de España de 500 habitantes o más
# desde 2021 a 2023.

csv_file <- raw_data_file("66620.csv.xz")
educ_data <- read_delim(csv_file, delim = ";",
                        locale = locale(decimal_mark = ",",
                                        grouping_mark = "."),
                       col_types = "ccccin") |>
  mutate(educ = make_factor(`Nivel de estudios`),
         age = make_factor(Edad),
         sex = make_factor(Sexo),
         mun_code = str_sub(`Municipios de 500 habitantes o más`, end = 5),) |>
  rename(year = Periodo, value = Total) |>
  select(-(1:4))
saveRDS(educ_data, file = data_file("ine_educ_data.rds"), compress = "xz")
```
