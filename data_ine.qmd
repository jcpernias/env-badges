---
itle: "Datos INE"
editor: visual
editor_options: 
  chunk_output_type: console
---

## Preliminares

### Librerías

Manipulación de datos:

```{r}
#| messages: false
#| warning: false

library(dplyr)
library(tidyr)
library(rlang)
```

Manipulación de cadenas:

```{r}
library(stringr)
library(glue)
```

Programación funcional (`map` y similares):

```{r}
#| warning: false

library(purrr)
```

Lectura de hojas de cálculo:

```{r}
library(readr)
```

Tablas:

```{r}
library(tinytable)
library(modelsummary)
```

{{< include _global.qmd >}}

## Códigos de CC. AA., provincias y municipios

Códigos INE de los municipios.

```{r}
mun_codes <- read_csv(data_file("ine_mun_codes.csv"),
                      col_types = "cccc") |>
  mutate(mun_code = glue("{prov_code}{mun_order}"))
```

En el Atlas siguen apareciendo municipios que ya no existen, o que han cambiado de provincia.

| Código | Municipio    | Causa                                                  |
|--------|--------------|--------------------------------------------------------|
| 04039  | Darrical     | Desaparece en 1997 incorporándose a Alcolea            |
| 12066  | Gatova       | Pasa a la provincia de Valencia en 1995                |
| 15026  | Cesuras      | Fusión en 2013 con Oza dos Ríos creándose Oza-Cesuras  |
| 15063  | Oza dos Ríos | Fusión en 2013 con Cesuras creándose Oza-Cesuras       |
| 17122  | Palmerola    | Desaparece en 1991 incorporándose a Les Lloses         |
| 36011  | Cerdedo      | Fusión en 2016 con Cotobade creándose Cerdedo-Cotobade |
| 36012  | Cotobade     | Fusión en 2016 con Cerdedo creándose Cerdedo-Cotobade  |

```{r}
drop_mun_codes <- c("04039", "12066", "15026", "15063", 
                    "17122", "36011", "36012")
```

## Atlas de la distribución de la renta

Nombres de las variables del Atlas:

```{r}
var_names <- read_csv(data_file("ine_atlas_vars.csv"),
                      col_types = "cc")
```

```{r}
#| echo: false
tt(var_names)
```

Función para leer los archivos csv del INE:

```{r}
read_ine_csv <- function(csv_file) {
  read_delim(csv_file, delim = ";",
             locale = locale(decimal_mark = ",",
                             grouping_mark = "."),
             na = c("", ".", ".."),
             col_types = "ccccin")
}
```

Función para leer los archivos del Atlas:

```{r}
read_atlas_file <- function(csv_file) {
  read_ine_csv(csv_file) |>
    filter(is.na(Distritos), is.na(Secciones), !is.na(Total),
           Periodo %in% years) |>
    mutate(mun_code = str_sub(Municipios, end = 5)) |>
    select(-c(Municipios, Distritos, Secciones)) |>
    filter(!mun_code %in% drop_mun_codes) |>
    rename(var_label = 1, year = Periodo, value = Total)
}
```

Datos del Atlas de distribución de renta de los hogares. Serie 2015--2023. Se usan 3 archivos proporcionados por el INE:

-   `30824.csv`: Renta.
-   `30832.csv`: Demografía.
-   `37677.csv`: Distribución de la renta.

```{r}
base_names <- c("30824", "30832", "37677")
csv_files <- raw_data_file(glue("{base_names}.csv.xz"))

db <- map(csv_files, read_atlas_file) |>
  bind_rows() |>
  left_join(var_names, by = "var_label") |>
  select(-var_label) |>
  pivot_wider(names_from = var, values_from = value)

save_data(db, "ine_atlas_data.rds")
```

```{r}
#| echo: false

datasummary_skim(db, 
                 fun_numeric = 
                   list(Mean = Mean, SD = SD, 
                        Min = Min, Median = Median, Max = Max, 
                        `Missing Pct.` = PercentMissing),
                 type = "numeric") |> 
  tt_style(j = 2:7, align = "r")
```

## Censo anual de población

En el archivo `ine_educ_labels.csv`, se encuentran las etiquetas que utiliza el INE para los diferentes valores de las variables categóricas.

```{r}
ine_educ_labels <- read_csv(data_file("ine_educ_labels.csv"),
                            col_types = "ccc")
```

```{r}
#| echo: false

tt(ine_educ_labels, width = c(0.2, 0.6, 0.2))  
  
```

Función para crear factores:

```{r}
make_factor <- function(x) {
  labs <- ine_educ_labels |>
    filter(var == as_label(enquo(x)))
  new_levels  <- labs$level
  tbl <- new_levels
  names(tbl) <- labs$ine_label
  factor(tbl[x], levels = new_levels) |>
    unname()
}
```

Lee los datos de población municipal por estudios completados, tramo de edad y sexo. Datos para todos los municipios de España de 500 habitantes o más desde 2021 a 2023.

```{r}
#| eval: false

educ_data <- read_ine_csv(raw_data_file("66620.csv.xz")) |>
  mutate(educ = make_factor(`Nivel de estudios`),
         age = make_factor(Edad),
         sex = make_factor(Sexo),
         mun_code = str_sub(`Municipios de 500 habitantes o más`, end = 5)) |>
  rename(year = Periodo, value = Total) |>
  select(-(1:4))

save_data(educ_data, "ine_educ_data.rds")
```
