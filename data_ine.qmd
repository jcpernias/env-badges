---
itle: "Datos INE"
editor: visual
editor_options: 
  chunk_output_type: console
---

## Preliminares

### Librerías

Manipulación de datos:

```{r}
#| messages: false
#| warning: false

library(dplyr)
library(tidyr)
library(rlang)
```

Manipulación de cadenas:

```{r}
library(stringr)
library(glue)
```

Programación funcional (`map` y similares):

```{r}
#| warning: false

library(purrr)
```

Lectura de hojas de cálculo:

```{r}
library(readr)
```

Tablas:

```{r}
library(tinytable)
library(modelsummary)
```

{{< include _global.qmd >}}

## Códigos de CC. AA., provincias y municipios

Códigos INE de los municipios.

```{r}
mun_codes <- read_csv(data_file("ine_mun_codes.csv"),
                      col_types = "cccc") |>
  mutate(mun_code = glue("{prov_code}{mun_order}"))
```

En el Atlas siguen apareciendo municipios que ya no existen, o que han cambiado de provincia.

| Código | Municipio    | Causa                                                  |
|-------------------|-------------------|------------------------------------|
| 04039  | Darrical     | Desaparece en 1997 incorporándose a Alcolea            |
| 12066  | Gatova       | Pasa a la provincia de Valencia en 1995                |
| 15026  | Cesuras      | Fusión en 2013 con Oza dos Ríos creándose Oza-Cesuras  |
| 15063  | Oza dos Ríos | Fusión en 2013 con Cesuras creándose Oza-Cesuras       |
| 17122  | Palmerola    | Desaparece en 1991 incorporándose a Les Lloses         |
| 36011  | Cerdedo      | Fusión en 2016 con Cotobade creándose Cerdedo-Cotobade |
| 36012  | Cotobade     | Fusión en 2016 con Cerdedo creándose Cerdedo-Cotobade  |

```{r}
drop_mun_codes <- c("04039", "12066", "15026", "15063", 
                    "17122", "36011", "36012")
```

## Atlas de la distribución de la renta

Nombres de las variables del Atlas:

```{r}
var_names <- read_csv(data_file("ine_atlas_vars.csv"),
                      col_types = "cc")
```

```{r}
#| echo: false
tt(var_names)
```

Función para leer los archivos csv del INE:

```{r}
read_ine_csv <- function(csv_file, col_types = "ccccin", ...) {
  read_delim(csv_file, delim = ";",
             locale = locale(decimal_mark = ",",
                             grouping_mark = "."),
             na = c("", ".", ".."),
             col_types = col_types, 
             ...)
}
```

Función para leer los archivos del Atlas:

```{r}
read_atlas_file <- function(csv_file) {
  read_ine_csv(csv_file) |>
    filter(is.na(Distritos), is.na(Secciones), !is.na(Total),
           Periodo %in% years) |>
    mutate(mun_code = str_sub(Municipios, end = 5)) |>
    select(-c(Municipios, Distritos, Secciones)) |>
    filter(!mun_code %in% drop_mun_codes) |>
    rename(var_label = 1, year = Periodo, value = Total)
}
```

Datos del Atlas de distribución de renta de los hogares. Serie 2015--2023. Se usan 3 archivos proporcionados por el INE:

-   `30824.csv`: Renta.
-   `30832.csv`: Demografía.
-   `37677.csv`: Distribución de la renta.

```{r}
base_names <- c("30824", "30832", "37677")
csv_files <- raw_data_file(glue("{base_names}.csv.xz"))

atlas_data <- map(csv_files, read_atlas_file) |>
  bind_rows() |>
  left_join(var_names, by = "var_label") |>
  select(-var_label) |>
  pivot_wider(names_from = var, values_from = value)

save_data(atlas_data, "ine_atlas_data.rds")
```

```{r}
#| echo: false

atlas_data |> 
  select(-year) |> 
  datasummary_skim(fun_numeric = 
                     list(Mean = Mean, SD = SD, 
                          Min = Min, Median = Median, Max = Max, 
                          `Missing Pct.` = PercentMissing),
                   type = "numeric") |> 
  tt_style(j = 2:7, align = "r")
```

## Censo anual de población

### Población

Población municipal obtenidos del Censo anual de población publicado en el INE. Datos para todos los municipios de España desde 2021 a 2024. Población total, por sexo y por país de nacimiento (grandes grupos).

```{r}
pop_data <- read_ine_csv(raw_data_file("68538.csv.xz"),
                          col_types = "__cccin",
                          col_names = c("Municipio", "Sexo", "Nacimiento", 
                                        "year", "value"),
                          skip = 1) |> 
  filter(!is.na(Municipio), 
         Nacimiento %in% c("Total", "España"), Sexo != "Total") |> 
  mutate(mun_code = str_sub(Municipio, end = 5)) |>
  select(-Municipio) |> 
  relocate(mun_code) |> 
  pivot_wider(names_from = c(Sexo, Nacimiento)) |> 
  mutate(pop = Hombres_Total + Mujeres_Total,
         pop_native = Hombres_España + Mujeres_España) |> 
  rename(pop_men = Hombres_Total, pop_women = Mujeres_Total) |> 
  select(-c(Hombres_España, Mujeres_España)) |> 
  relocate(pop, .after = year) 

save_data(pop_data, "ine_pop_data.rds")
```

```{r}
#| echo: false

pop_data |> 
  select(-year) |> 
  datasummary_skim(fun_numeric = 
                     list(Mean = Mean, SD = SD, 
                          Min = Min, Median = Median, Max = Max, 
                          `Missing Pct.` = PercentMissing),
                   type = "numeric") |> 
  tt_style(j = 2:7, align = "r")
```

## Edad

Población de los municipios por sexo y edad (año a año) para el periodo 2021-2024.

```{r}
age_data <- read_ine_csv(raw_data_file("68542.csv.xz"),
                          col_types = "__cccin",
                          col_names = c("Municipio", "Sexo", "Edad", 
                                        "year", "value"),
                          skip = 1) |> 
  filter(!is.na(Municipio), 
         Edad != "Todas las edades", Sexo == "Total")  |> 
  mutate(mun_code = str_sub(Municipio, end = 5),
         age = as.integer(str_extract(Edad, "^[0-9]+"))) |>
  filter(value != 0) |> 
  select(mun_code, year, age, value) |> 
  group_by(mun_code, year) |> 
  summarise(pop_lt_18 = sum(value * (age < 18)),
            pop_gt_65 = sum(value * (age > 65)),
            avg_age = weighted.mean(age, value), 
            .groups = "drop")
```

```{r}
#| echo: false

age_data |> 
  select(-year) |> 
  datasummary_skim(fun_numeric = 
                     list(Mean = Mean, SD = SD, 
                          Min = Min, Median = Median, Max = Max, 
                          `Missing Pct.` = PercentMissing),
                   type = "numeric") |> 
  tt_style(j = 2:7, align = "r")
```

### Educación

Variables para transformar las etiquetas que utiliza el INE para los diferentes niveles de estudios.

```{r}

educ_labels <- 
  c("Educación primaria e inferior",
    "Primera etapa de Educación Secundaria y similar",
    "Segunda etapa de Educación Secundaria y Educación Postsecundaria no Superior",
    "Educación superior")

educ_levels <- c("ed_prim", "ed_sec_low", "ed_sec_high", "ed_sup") |> 
  set_names(educ_labels)
```

```{r}
#| echo: false

tibble(levels = unname(educ_levels),
       INE = names(educ_levels)) |> 
         tt(width = c(0.15, 0.85))  
  
```

Población de 15 años o más por estudios completados. Datos para todos los municipios de España de 500 habitantes o más desde 2021 a 2023.

```{r}


educ_data <- read_ine_csv(raw_data_file("66620.csv.xz")) |> 
  filter(Sexo == "Total", 
         Edad == "15 y más años", 
         `Nivel de estudios` != "Total") |> 
  mutate(educ = factor(educ_levels[`Nivel de estudios`],
                       levels = unname(educ_levels)),
         mun_code = str_sub(`Municipios de 500 habitantes o más`, 
                            end = 5))  |> 
  rename(year = Periodo, value = Total) |>
  select(mun_code, year, educ, value) |>
  pivot_wider(names_from = educ, values_from = value)

save_data(educ_data, "ine_educ_data.rds")
```

```{r}
#| echo: false

educ_data |> 
  select(-year) |> 
  datasummary_skim(fun_numeric = 
                     list(Mean = Mean, SD = SD, 
                          Min = Min, Median = Median, Max = Max, 
                          `Missing Pct.` = PercentMissing),
                   type = "numeric") |> 
  tt_style(j = 2:7, align = "r")
```

## Consolidación de las bases de datos del INE

```{r}
ine_data <- atlas_data |>
  select(-pop) |> 
  left_join(pop_data, by = join_by(mun_code, year))
```

```{r}

```
