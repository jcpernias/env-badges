---
title: "Datos"
editor: visual
editor_options: 
  chunk_output_type: console
---

## Librerías y funciones comunes

Carga las librerías necesarias:

```{r}
#| messages: false
#| warning: false

# Manipulación de datos
library(dplyr)

# Programación funcional
library(purrr)

# Manipulación de cadenas 
library(stringr)
library(glue)

# Lectura de hojas de cálculo y archivos SPSS
library(readr)
library(readxl)

# Tablas
library(tinytable)
```

Define los directorios de datos:

```{r}
data_dir <- "data"
raw_data_dir <- file.path(data_dir, "orig")
```

Aunque algunas fuentes ofrecen datos para más años, sólo se dispone de información completa para el periodo 2021--2023:

```{r}
years <- 2021:2023
```

Función para guardar los datos una vez procesados:

```{r}
save_data <- function(x, fname) {
  saveRDS(x, file = file.path(data_dir, fname), 
          compress = "xz")
}
```

## DGT

Desde 2021 la DGT proporciona ficheros Excel con información municipal, incluyendo el número de vehículos por distintivo ambiental.

Tabla con los nombres de los ficheros:

```{r}
dgt_files <- local({
  glue_str <- "DatosMunicipalesGeneral_{years}.xlsx"
  tibble(file = file.path(raw_data_dir, glue(glue_str)),
         year = years)
})

tt(dgt_files)
```

Diccionario de los ficheros de la DGT

-   `column`: Número de columna de la hoja de cálculo.
-   `label`: Nombre de la columna en la hoja de cálculo.
-   `name`: Nombre de la variable.
-   `type`: Tipo de variable ('c' para texto, 'i' para enteros y 'd' para reales).

```{r}
dgt_dict <-
  read_csv(file.path(data_dir, "dgt_mun_dict.csv"),
           col_types = "icc") |>
  mutate(excel_col_types = 
           case_when(is.na(name) ~ "skip",
                     type == "c" ~ "text",
                     .default = "numeric"))
tt(dgt_dict)
```

Función que lee los datos de un año:

```{r}
# Lee datos de un año
read_dgt_file <- function(input_file, year, dict) {
  # El año 2021 hay una variable menos
  if (year == 2021) {
    dict <- dict |> filter(column != 57)
  }
  
  read_xlsx(input_file, skip = 1,
            col_types = dict$excel_col_types,
            col_names = dict$name) |>
    filter(!str_detect(mun, fixed("sin especificar"))) |>
    mutate(year = year)
}
```

Lee los datos de todos los años y los combina:

```{r}
db <- 
  pmap(dgt_files,
       \(file, year) read_dgt_file(file, year, dgt_dict)) |>
  bind_rows()
```

Guarda los datos:

```{r}
save_data(db, "dgt_mun_data.rds")
```

Estructura de los datos:

```{r}
str(db)
```
